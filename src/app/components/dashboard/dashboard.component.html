<!-- dashboard.component.html -->
<div class="dashboard-container">
  
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>Binance Bot Dashboard</h1>
      <p class="subtitle">Monitoraggio in Tempo Reale</p>
    </div>
    <div class="header-right">
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="openAnalyticsModal()">
          ðŸ“Š Analisi Tecnica
        </button>
        <button class="btn btn-secondary" (click)="openAlertsModal()">
          ðŸ”” Gestione Alert
        </button>
        <app-notification-center></app-notification-center>
        <div class="connection-status" [class.connected]="wsOpen">
          <span class="status-dot"></span>
          {{ wsOpen ? 'CONNESSO' : 'DISCONNESSO' }}
        </div>
      </div>
    </div>
  </div>

  <!-- Symbol Selector -->
  <app-symbol-selector 
    (symbolsChange)="onSymbolsChange($event)"
    (clearAll)="onClearAll()">
  </app-symbol-selector>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="symbols-info">
      <strong>Simboli attivi:</strong>
      <span class="active-symbols">{{ symbolsInput || 'nessuno' }}</span>
      â€¢
      <span class="symbols-count">{{ getActiveSymbolsCount() }} simboli</span>
    </div>

    <div class="buttons-group">
      <button class="btn btn-primary" (click)="start()" [disabled]="wsOpen || !symbolsInput">
        {{ isConnecting ? 'CONNESSIONE...' : (wsOpen ? 'CONNESSO' : 'CONNETTI WS') }}
      </button>
      <button class="btn btn-secondary" (click)="refresh()" [disabled]="!symbolsInput">
        AGGIORNA DATI
      </button>
      <button class="btn btn-danger" (click)="stop()" [disabled]="!wsOpen">
        DISCONNETTI
      </button>
    </div>
  </div>

  <!-- Statistics -->
  <div class="stats-section">
    <div class="stat-card">
      <span class="stat-label">Simboli Attivi</span>
      <span class="stat-value">{{ getActiveSymbolsCount() }}</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Messaggi Ricevuti</span>
      <span class="stat-value">{{ messagesReceived }}</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Ultimo Aggiornamento</span>
      <span class="stat-value">{{ lastUpdate | date:'HH:mm:ss' }}</span>
    </div>
  </div>

  <!-- Ticker Selezionato -->
  <div class="selected-ticker-section" *ngIf="selectedTicker">
    <div class="ticker-header">
      <h2>{{ selectedTicker.toUpperCase() }} - Dettaglio</h2>
      <div class="ticker-actions">
        <button class="btn btn-sm btn-secondary" (click)="openAnalyticsModal(selectedTicker)">
          ðŸ“Š Analisi
        </button>
        <button class="btn btn-sm btn-secondary" (click)="openAlertsModal(selectedTicker)">
          ðŸ”” Alert
        </button>
        <button class="btn btn-sm btn-outline" (click)="clearSelection()">
          Chiudi Dettaglio
        </button>
      </div>
    </div>
    
    <div class="ticker-content">
      <!-- Dettagli Ticker -->
      <div class="ticker-details" *ngIf="getTickerDetails(selectedTicker) as tickerData">
        <div class="detail-grid">
          <div class="detail-card">
            <span class="label">Prezzo corrente:</span>
            <span class="value" [class.positive]="getPriceChangePercent(tickerData) > 0" 
                  [class.negative]="getPriceChangePercent(tickerData) < 0">
              ${{ tickerData.last_price | number:'1.2-2' }}
            </span>
          </div>
          <div class="detail-card">
            <span class="label">24h High:</span>
            <span class="value">${{ tickerData.high_price | number:'1.2-2' }}</span>
          </div>
          <div class="detail-card">
            <span class="label">24h Low:</span>
            <span class="value">${{ tickerData.low_price | number:'1.2-2' }}</span>
          </div>
          <div class="detail-card">
            <span class="label">Volume:</span>
            <span class="value">{{ tickerData.volume | number:'1.0-0' }}</span>
          </div>
          <div class="detail-card">
            <span class="label">Variazione:</span>
            <span class="value" [class.positive]="getPriceChangePercent(tickerData) > 0" 
                  [class.negative]="getPriceChangePercent(tickerData) < 0">
              {{ getPriceChangePercent(tickerData) | number:'1.2-2' }}%
            </span>
          </div>
        </div>
      </div>

      <!-- Price Chart -->
      <app-price-chart
        *ngIf="getPriceHistory(selectedTicker).length > 0"
        [title]="selectedTicker.toUpperCase()"
        [data]="getPriceHistory(selectedTicker)"
        [labels]="chartLabels()"
        [symbol]="selectedTicker.toUpperCase()">
      </app-price-chart>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!selectedTicker">
    <!-- Charts Section -->
    <div class="charts-section">
      <div class="section-header">
        <h3>Grafici Prezzi in Tempo Reale</h3>
        <span class="section-info">
          {{ chartSymbols().length }} grafici attivi
        </span>
      </div>
      
      <div class="charts-grid">
        <ng-container *ngFor="let sym of chartSymbols()">
          <app-price-chart
            *ngIf="getPriceHistory(sym).length > 0"
            [title]="sym.toUpperCase()"
            [data]="getPriceHistory(sym)"
            [labels]="chartLabels()"
            [symbol]="sym.toUpperCase()">
          </app-price-chart>
        </ng-container>
      </div>
      
      <div *ngIf="chartSymbols().length === 0" class="no-charts">
        <p>Seleziona dei simboli per vedere i grafici in tempo reale</p>
      </div>
    </div>

    <!-- MiniTicker Table -->
    <div class="table-section">
      <div class="section-header">
        <h3>Dati in Tempo Reale</h3>
        <span class="table-info">
          {{ miniTickers().length }} simboli â€¢ 
          Ultimo agg: {{ lastUpdate | date:'HH:mm:ss' }}
        </span>
      </div>
      <app-mini-ticker-table
        [tickers]="miniTickers()"
        [title]="''"
        (tickerSelect)="selectTicker($event)">
      </app-mini-ticker-table>
    </div>
  </div>

  <!-- Live Feed -->
  <div class="feed-section">
    <div class="section-header">
      <h3>Live WebSocket Feed</h3>
      <div class="section-controls">
        <button class="btn btn-sm" (click)="clearFeed()">Pulisci</button>
      </div>
    </div>
    <div class="feed-container">
      <pre class="feed-content">{{ lastMsg | json }}</pre>
    </div>
  </div>

  <!-- Modali -->
  @if (showAnalyticsModal) {
    <app-modal-container 
      title="Analisi Tecnica {{modalSymbol ? '- ' + modalSymbol.toUpperCase() : ''}}"
      size="xl"
      (closed)="closeModals()">
      <app-analytics-dashboard [selectedSymbol]="modalSymbol"></app-analytics-dashboard>
    </app-modal-container>
  }

  @if (showAlertsModal) {
    <app-modal-container 
      title="Gestione Alert Prezzi {{modalSymbol ? '- ' + modalSymbol.toUpperCase() : ''}}"
      size="lg"
      (closed)="closeModals()">
      <app-alert-manager [filterBySymbol]="modalSymbol"></app-alert-manager>
    </app-modal-container>
  }

</div>